<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <head>
        <meta http-equiv="cache-control" content="max-age=86400"/>
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=9"/>
        <meta name="generator" content="Doxygen 1.14.0"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>qb: Core Concept: Concurrency &amp; Parallelism in QB</title>
        <meta name="description" content="qb OpenSource C++17 Actor Framework Documentation, all API detailed">
        <meta name="keywords"
              content="qb, cube, actor, framework, actor framework, opensource, cpp, c++, cpp17, c++17, documentation, docs, git">
        <meta name="author" content="isndev">
        <!-- BEGIN opengraph metadata -->
<!--        <meta property="og:title" content="Doxygen Awesome"/>-->
<!--        <meta property="og:image"-->
<!--              content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452"/>-->
<!--        <meta property="og:description"-->
<!--              content="Custom CSS theme for doxygen html-documentation with lots of customization parameters."/>-->
<!--        <meta property="og:url" content="https://jothepro.github.io/doxygen-awesome-css/"/>-->
        <!-- END opengraph metadata -->
        <!-- BEGIN twitter metadata -->
<!--        <meta name="twitter:image:src"-->
<!--              content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452"/>-->
<!--        <meta name="twitter:title" content="Doxygen Awesome"/>-->
<!--        <meta name="twitter:description"-->
<!--              content="Custom CSS theme for doxygen html-documentation with lots of customization parameters."/>-->
        <!-- END twitter metadata -->
        <title>qb: Core Concept: Concurrency &amp; Parallelism in QB</title>
        <link href="tabs.css" rel="stylesheet" type="text/css"/>
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
        <script type="text/javascript" src="jquery.js"></script>
        <script type="text/javascript" src="dynsections.js"></script>
        <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
        <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
        <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
        <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
        <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
        <script type="text/javascript" src="toggle-alternative-theme.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeFragmentCopyButton.init()
            DoxygenAwesomeDarkModeToggle.init()
            DoxygenAwesomeParagraphLink.init()
            DoxygenAwesomeInteractiveToc.init()
            DoxygenAwesomeTabs.init()
        </script>
        <script async defer src="https://buttons.github.io/buttons.js"></script>
        <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css"/>
        <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
    </head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/isndev/qb" class="github-corner" title="View source on GitHub"
   target="_blank" rel="noopener noreferrer">
    <svg viewBox="0 0 250 250" width="40" height="40"
         style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm {
    animation: octocat-wave 560ms ease-in-out
}
@keyframes octocat-wave {
    0%, 100% {
        transform: rotate(0)
    }
    20%, 60% {
        transform: rotate(-25deg)
    }
    40%, 80% {
        transform: rotate(10deg)
    }
}
@media (max-width: 500px) {
    .github-corner:hover .octo-arm {
        animation: none
    }
    .github-corner .octo-arm {
        animation: octocat-wave 560ms ease-in-out
    }
}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
            <tbody>
            <tr style="height: 56px;">
                <td id="projectlogo"><img alt="Logo" src="logo.svg"/></td>
                <td id="projectalign" style="padding-left: 0.5em;">
                    <div id="projectname">qb
                        &#160;<span id="projectnumber">2.0.0.0</span>
                    </div>
                    <div id="projectbrief">C++17 Actor Framework</div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div style="padding-left: 0.5em;">
        <a class="navbar-brand" href="https://github.com/isndev/qb">
            <img src="GitHub-Mark-64px.png" width="32px" alt="qb">
        </a>
        <a class="github-button" href="https://github.com/isndev/qb/issues" data-icon="octicon-issue-opened" data-size="large" data-show-count="true" aria-label="Issue isndev/qb on GitHub">Issue</a>
        <a class="github-button" href="https://github.com/isndev/qb/subscription" data-icon="octicon-eye" data-size="large" data-show-count="true" aria-label="Watch isndev/qb on GitHub">Watch</a>
        <a class="github-button" href="https://github.com/isndev/qb" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star isndev/qb on GitHub">Star</a>
        <a class="github-button" href="https://github.com/isndev/qb/fork" data-icon="octicon-repo-forked" data-size="large" data-show-count="true" aria-label="Fork isndev/qb on GitHub">Fork</a>
        <a class="github-button" href="https://github.com/isndev" data-size="large" data-show-count="false" aria-label="Follow @isndev on GitHub">Follow @isndev</a>
    </div>
    <!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('core_concepts_concurrency_md.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Core Concept: Concurrency &amp; Parallelism in QB </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Explore how QB orchestrates concurrent actor execution and achieves true parallelism using VirtualCores.</p>
<h1>Core Concept: Concurrency and Parallelism in QB</h1>
<p>The QB Actor Framework is designed to make concurrent programming more manageable and to effectively utilize modern multi-core processors for parallel execution. It achieves this through a clear separation of concerns managed by the <span class="tt"><a class="el" href="classqb_1_1_main.html" title="The main controller for the QB Actor Framework engine.">qb::Main</a></span> engine and its <span class="tt">VirtualCore</span> worker threads.</p>
<h2>Concurrency vs. Parallelism in QB</h2>
<p>It's important to distinguish these two terms in the context of QB:</p>
<ul>
<li><b>Concurrency:</b> This refers to the ability of the system to handle multiple tasks or actors <em>seemingly</em> at the same time. Even on a single CPU core, actors can make progress independently, especially when some are waiting for I/O (handled asynchronously by <span class="tt">qb-io</span>) while others are processing events. QB provides concurrency by allowing many actors to exist and react to messages without blocking each other unnecessarily.</li>
<li><b>Parallelism:</b> This refers to the ability of the system to execute multiple tasks or actors <em>literally</em> at the same time, by running them on different physical CPU cores. QB achieves parallelism by distributing actors across multiple <span class="tt">VirtualCore</span> threads, each of which can be mapped to a physical core.</li>
</ul>
<h2><span class="tt"><a class="el" href="classqb_1_1_main.html" title="The main controller for the QB Actor Framework engine.">qb::Main</a></span>: The Engine Orchestrator</h2>
<p>(<span class="tt"><a class="el" href="core_2main_8h.html" title="Main control for the QB Actor Framework.">qb/core/Main.h</a></span>)</p>
<p>The <span class="tt"><a class="el" href="classqb_1_1_main.html" title="The main controller for the QB Actor Framework engine.">qb::Main</a></span> class is the central controller of your actor system. Its primary responsibilities include:</p>
<ul>
<li><b>VirtualCore Management:</b> It creates and manages a pool of <span class="tt">VirtualCore</span> instances. By default, it often attempts to match the number of available hardware cores, but this is configurable.</li>
<li><b>Actor Distribution:</b> When you add actors to the system using <span class="tt">main.addActor&lt;MyActor&gt;(core_id, constructor_args...)</span>, you specify which <span class="tt">VirtualCore</span> (by its <span class="tt">core_id</span>) will be responsible for that actor.</li>
<li><b>System Lifecycle:</b> <span class="tt"><a class="el" href="classqb_1_1_main.html" title="The main controller for the QB Actor Framework engine.">qb::Main</a></span> controls the startup (<span class="tt">start()</span>) and shutdown (<span class="tt">stop()</span>, <span class="tt">join()</span>) of the entire actor system, including all <span class="tt">VirtualCore</span> threads.</li>
<li><b>Error Reporting:</b> It can detect if a <span class="tt">VirtualCore</span> terminates unexpectedly (e.g., due to an unhandled exception in an actor) via <span class="tt">main.hasError()</span>.</li>
</ul>
<h2><span class="tt"><a class="el" href="classqb_1_1_virtual_core.html" title="Manages a virtual processing core (worker thread) in the actor system.">qb::VirtualCore</a></span>: The Actor's Execution Realm</h2>
<p>(<span class="tt"><a class="el" href="_virtual_core_8h.html" title="Defines the VirtualCore class, representing a worker thread in the QB Actor Framework.">qb/core/VirtualCore.h</a></span>)</p>
<p>A <span class="tt">VirtualCore</span> is essentially a dedicated worker thread that hosts and executes a subset of the system's actors.</p>
<ul>
<li><b>Event Loop Hub:</b> Each <span class="tt">VirtualCore</span> runs its own independent <span class="tt"><a class="el" href="classqb_1_1io_1_1async_1_1listener.html" title="Central event loop manager for asynchronous IO operations.">qb::io::async::listener</a></span> event loop. This loop is the engine that drives all activity on that core, processing I/O events, timer events, and actor messages.</li>
<li><b>Actor Mailboxes &amp; Event Queues:</b><ul>
<li><b>Inter-Core Mailbox:</b> Each <span class="tt">VirtualCore</span> has an incoming MPSC (Multiple-Producer, Single-Consumer) queue. When an actor on <em>another</em> core sends a message to an actor on <em>this</em> core, the message (or its data) is placed into this mailbox.</li>
<li><b>Local Event Queue:</b> Events sent between actors residing on the <em>same</em> <span class="tt">VirtualCore</span> (e.g., via <span class="tt">push()</span>) are typically handled through a more direct local queueing mechanism within that core.</li>
</ul>
</li>
<li><b>Sequential Actor Execution (Crucial Guarantee):</b> Within a single <span class="tt">VirtualCore</span>, actors execute their event handlers (<span class="tt">on(Event&amp;)</span> methods) and callbacks (<span class="tt">onCallback()</span>) <b>one at a time, to completion</b>. The <span class="tt">VirtualCore</span> processes one event for one actor fully before picking up the next event for any actor on that core. This fundamental guarantee eliminates data races on an actor's internal state <em>from its own event handlers</em>, simplifying state management significantly.</li>
<li><b>Scheduling Logic (Simplified):</b> In each iteration of its main loop, a <span class="tt">VirtualCore</span> typically:<ol type="1">
<li>Checks for and processes I/O events from its <span class="tt">listener</span> (socket readiness, file system changes, timer expirations from <span class="tt"><a class="el" href="group___async.html#ga79acd187eb2aeb629523ebb206ee004d" title="Utility function to schedule a callable for execution after a timeout.">qb::io::async::callback</a></span> or <span class="tt"><a class="el" href="classqb_1_1io_1_1async_1_1with__timeout.html" title="CRTP base class that adds timeout functionality to derived asynchronous components.">qb::io::async::with_timeout</a></span>).</li>
<li>Dequeues and processes events from its inter-core mailbox.</li>
<li>Dequeues and processes events from its local event queue.</li>
<li>Invokes <span class="tt">onCallback()</span> for all actors on this core that have registered via <span class="tt"><a class="el" href="classqb_1_1_i_callback.html" title="Interface for actor callbacks.">qb::ICallback</a></span>.</li>
<li>Flushes any outgoing event pipes to other cores.</li>
<li>If configured with a non-zero latency and currently idle, it may briefly sleep.</li>
</ol>
</li>
</ul>
<h2>Inter-Core Communication: Efficient &amp; Transparent</h2>
<p>(<span class="tt"><a class="el" href="core_2main_8h.html" title="Main control for the QB Actor Framework.">qb/core/Main.h</a></span> - <span class="tt">SharedCoreCommunication</span>, <span class="tt"><a class="el" href="mpsc_8h.html" title="Multiple-Producer Single-Consumer lockfree queue.">qb/system/lockfree/mpsc.h</a></span>)</p>
<p>When an actor on <span class="tt">CoreA</span> sends an event to an actor on <span class="tt">CoreB</span>, QB handles the communication efficiently and (mostly) transparently:</p>
<ol type="1">
<li><b>Serialization:</b> The sending <span class="tt">VirtualCore</span> (CoreA) prepares the event data for transfer. For complex events, this might involve serialization; for simple events or those using <span class="tt">std::shared_ptr</span> for payloads, it primarily involves packaging pointers or small data.</li>
<li><b>Enqueue to Mailbox:</b> CoreA places the event (or a reference/pointer to its data) into the dedicated MPSC mailbox of the destination <span class="tt">VirtualCore</span> (CoreB).</li>
<li><b>Notification (Potentially):</b> CoreA might notify CoreB that new data is available in its mailbox, especially if CoreB was sleeping due_to_idle_latency.</li>
<li><b>Dequeue &amp; Dispatch:</b> CoreB, during its event loop cycle, dequeues the event data from its mailbox.</li>
<li><b>Delivery:</b> CoreB reconstructs the event if necessary and dispatches it to the target actor's appropriate <span class="tt">on()</span> handler.</li>
</ol>
<ul>
<li><b>Underlying Mechanism:</b> This inter-core communication relies on high-performance, lock-free MPSC queues (<span class="tt"><a class="el" href="classqb_1_1lockfree_1_1mpsc_1_1ringbuffer.html" title="Multi-Producer Single-Consumer ring buffer with fixed number of producers.">qb::lockfree::mpsc::ringbuffer</a></span>). This design minimizes contention between producing cores and ensures efficient delivery to the single consuming core.</li>
<li><b>Ordering Guarantees:</b><ul>
<li><span class="tt">push&lt;Event&gt;(dest, ...)</span>: Events sent from a specific actor A to a specific actor B will be processed by B in the order A pushed them, <em>even if A and B are on different cores</em>.</li>
<li><span class="tt">send&lt;Event&gt;(dest, ...)</span>: Provides no ordering guarantees, even for same-core communication.</li>
</ul>
</li>
</ul>
<p><b>(Reference Example:</b> <span class="tt">test-actor-event.cpp</span> (Multi core tests), <span class="tt">test-actor-service-event.cpp</span> illustrate inter-core messaging.**)</p>
<h2>Configuring Parallelism: Affinity &amp; Latency</h2>
<p>While QB handles much of the complexity, you can fine-tune how <span class="tt">VirtualCore</span> threads behave <em>before</em> starting the engine (<span class="tt">main.start()</span>):</p>
<ul>
<li><b>CPU Affinity (<span class="tt">main.core(core_id).setAffinity(CoreIdSet)</span>):</b> Pin a <span class="tt">VirtualCore</span> thread to one or more specific physical CPU cores. This can be beneficial for cache performance and reducing thread migration overhead for critical actors. It requires careful consideration to avoid overloading physical cores.</li>
<li><b>Event Loop Latency (<span class="tt">main.core(core_id).setLatency(nanoseconds)</span>):</b> Control how long a <span class="tt">VirtualCore</span> might sleep if it finds no immediate work.<ul>
<li><span class="tt">0</span> (default): Lowest latency, but the core spins at 100% CPU even if idle.</li>
<li><span class="tt">&gt;0</span>: Allows the core to sleep, reducing CPU usage at the cost of potentially introducing a slight delay in picking up new events. A small value (e.g., a few hundred microseconds to a millisecond) often provides a good balance.</li>
</ul>
</li>
</ul>
<p>Thoughtful configuration of actor placement, core affinity, and latency allows you to tailor QB's parallelism to your application's specific workload and hardware.</p>
<p><b>(Reference Guide:</b> Guides: Performance Tuning Guide**) <b>(Next:</b> QB-IO Module Overview or QB-Core Module Overview**)** </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="index.html">QB Actor Framework: High-Performance C++17 Concurrent Systems</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
